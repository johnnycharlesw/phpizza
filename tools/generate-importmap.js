#!/usr/bin/env node
/*
  Generate an import map from installed NPM packages for PHPizza.
  Outputs:
   - assets/phpizza-client-scripts/importmap.json (raw JSON)
   - assets/phpizza-client-scripts/importmap.generated.js (injects <script type="importmap"> at runtime)

  Usage:
    node tools/generate-importmap.js
*/

const fs = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname, '..');
const NODE_MODULES = path.join(ROOT, 'node_modules');
const OUT_DIR = path.join(ROOT, 'assets', 'phpizza-client-scripts');
const OUT_JSON = path.join(OUT_DIR, 'importmap.json');
const OUT_INJECTOR = path.join(OUT_DIR, 'importmap.generated.js');

function readJson(p) {
  return JSON.parse(fs.readFileSync(p, 'utf8'));
}

function pickEntry(pkgJson) {
  // Prefer ESM entry points when available.
  // Heuristics: module -> exports["."].import -> exports["."] -> main -> index.js
  if (typeof pkgJson.module === 'string' && pkgJson.module.trim()) {
    return pkgJson.module.trim();
  }
  const ex = pkgJson.exports;
  if (typeof ex === 'string' && ex.trim()) {
    return ex.replace(/^\.\//, '').trim();
  }
  if (ex && typeof ex === 'object') {
    const dot = ex['.'];
    if (typeof dot === 'string' && dot.trim()) {
      return dot.replace(/^\.\//, '').trim();
    }
    if (dot && typeof dot === 'object') {
      if (typeof dot.import === 'string' && dot.import.trim()) {
        return dot.import.replace(/^\.\//, '').trim();
      }
      if (typeof dot.default === 'string' && dot.default.trim()) {
        return dot.default.replace(/^\.\//, '').trim();
      }
    }
  }
  if (typeof pkgJson.main === 'string' && pkgJson.main.trim()) {
    return pkgJson.main.trim();
  }
  return 'index.js';
}

function ensureJsSuffix(p) {
  // If entry resolves to a directory, append index.js. Otherwise return as-is.
  if (p.endsWith('/')) return p + 'index.js';
  return p;
}

function rel(...parts) {
  return parts.join('/').replace(/\\+/g, '/');
}

function main() {
  const pkgPath = path.join(ROOT, 'package.json');
  const rootPkg = readJson(pkgPath);
  const deps = Object.keys(rootPkg.dependencies || {});

  if (!deps.length) {
    console.log('No dependencies found to generate import map.');
  }

  const imports = {};
  for (const pkg of deps) {
    try {
      const pkgDir = path.join(NODE_MODULES, pkg);
      const pkgJsonPath = path.join(pkgDir, 'package.json');
      const pkgJson = readJson(pkgJsonPath);
      let entry = pickEntry(pkgJson);
      entry = entry.replace(/^\.\//, '');
      entry = ensureJsSuffix(entry);

      // Map to PHP AssetLoader endpoint so it serves the JS with correct headers.
      // Note: AssetLoader rejects unsafe characters, so scoped packages (e.g., @scope/pkg) may not work.
      // Your current dependencies are unscoped.
      const relPath = rel('node_modules', pkg, entry);
      imports[pkg] = `/load.php?t=js&f=${relPath}`;
    } catch (e) {
      console.warn(`Skipping ${pkg}: ${e.message}`);
    }
  }

  // Ensure output dir
  fs.mkdirSync(OUT_DIR, { recursive: true });

  // Write JSON
  const json = JSON.stringify({ imports }, null, 2);
  fs.writeFileSync(OUT_JSON, json);

  // Write injector that embeds the JSON as inline importmap.
  const injector = `/* Auto-generated by tools/generate-importmap.js */\n(function(){\n  try{\n    var imports = ${JSON.stringify(imports, null, 2)};\n    var s = document.createElement('script');\n    s.type = 'importmap';\n    s.textContent = JSON.stringify({ imports: imports }, null, 2);\n    var parent = document.currentScript && document.currentScript.parentNode ? document.currentScript.parentNode : document.head || document.documentElement;\n    parent.insertBefore(s, document.currentScript || parent.firstChild);\n    console.log('Local import map generated!');\n  }catch(e){\n    console.warn('Failed to inject import map:', e);\n  }\n})();\n`;
  fs.writeFileSync(OUT_INJECTOR, injector);

  console.log(`Import map written to:\n - ${path.relative(ROOT, OUT_JSON)}\n - ${path.relative(ROOT, OUT_INJECTOR)}`);
}

main();
